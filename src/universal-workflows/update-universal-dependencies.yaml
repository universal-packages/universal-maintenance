name: Update Universal Dependencies

maxConcurrentRoutines: 1

routines:
  gather-universal-dependencies:
    steps:
      - name: universal-dependencies
        use: gather-universal-dependencies

  update-universal-dependencies:
    strategy:
      include: outputs.gather-universal-dependencies.universal-dependencies

    dependsOn: gather-universal-dependencies

    steps:
      - run: npm update ${{ strategy.name }} ${{ strategy.save }}

  after-universal-dependencies-update:
    dependsOn: update-universal-dependencies

    steps:
      - name: result
        use: after-universal-dependencies-update
        with:
          universalDependenciesRoutine: gather-universal-dependencies
          universalDependenciesStep: universal-dependencies

  test-after-update:
    if: outputs.after-universal-dependencies-update.result.shouldCommit
    dependsOn: after-universal-dependencies-update
    steps:
      - run: npm run test:full

  commit-update:
    if: outputs.after-universal-dependencies-update.result.shouldCommit

    dependsOn: test-after-update

    steps:
      - run: git add .
      - run: git commit -m "Bump @universal-packages dependencies"
      - run: git push

  create-tag:
    if: outputs.after-universal-dependencies-update.result.shouldCreateTag

    dependsOn: commit-update

    steps:
      - run: npm version patch
      - run: git push
      - run: git push --tags
